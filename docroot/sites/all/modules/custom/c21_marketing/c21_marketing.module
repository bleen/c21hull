<?php
/**
 * @file
 * Code for the c21 Marketing feature.
 */

include_once 'c21_marketing.features.inc';

/**
 * Implements hook_page_alter().
 */
function c21_marketing_page_alter(&$page) {
  // Remove the page title from basic pages.
  if ($page['#type'] == 'page') {
    unset($page['content']['blockify_blockify-page-title']);
  }

  // Add som extra google analytics code for the "thank you" page only.
  if (module_exists('googleanalytics') && isset($page['content']['system_main']['nodes']['10528'])) {
    drupal_add_js(' <!-- Google Code for Lead Conversion Page -->
      /* <![CDATA[ */
      var google_conversion_id = 1063218418;
      var google_conversion_language = "zh_CN";
      var google_conversion_format = "1";
      var google_conversion_color = "ffffff";
      var google_conversion_label = "rmU2CNaNRBDy2f36Aw";
      var google_conversion_value = 1.000000;
      var google_remarketing_only = false;
      /* ]]> */',
      array('type' => 'inline', 'scope' => 'footer')
    );
    drupal_add_js('//www.googleadservices.com/pagead/conversion.js', 'external');
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function c21_marketing_form_contact_site_form_alter(&$form, &$form_state) {
  // Remove the subject & message fields.
  $form['subject']['#access'] = FALSE;
  $form['message']['#access'] = FALSE;
  $form['copy']['#access'] = FALSE;

  $form['#submit'][] = 'c21_marketing_form_contact_site_form_submit';

  // Change the submit button text.
  $form['actions']['submit']['#value'] = t('Contact Us');

  // Add placeholders and remove titles from the email an name fields.
  $form['name']['#title'] = '';
  $form['name']['#placeholder'] = t('Your Name');
  $form['mail']['#title'] = '';
  $form['mail']['#placeholder'] = t('Your Email Address');

  // Add some copy at the top of the form.
  $form['blurb'] = array(
    '#markup' => '<h2>Speak to a Real Estate Professional</h2><p>Get the personalized attention you deserve. Fill out this form to have one of our full-time, certified REALTORS<sup>&reg;</sup> contact you.</p>',
    '#theme_wrappers' => array('container'),
    '#attributes' => array('class' => array('blurb')),
  );

  // Add a phone field.
  $form['phone'] = array(
    '#type' => 'textfield',
    '#placeholder' => '555-555-5555',
  );

  // Add a field to indicate if the user is interested in buying or selling.
  $form['buy_sell'] = array(
    '#title' => t('I\'m interested in'),
    '#type' => 'select',
    '#options' => array(
      'buying' => t('buying'),
      'selling' => t('selling'),
    ),
    '#default_value' => 'buying',
  );

  $form['when'] = array(
    '#title' => t('I\'d like to buy or sell'),
    '#type' => 'select',
    '#options' => array(
      'now' => t('right away'),
      '1-3 month' => t('in 1-3 months'),
      '3-6 months' => t('in 3-6 months'),
      '6+ months' => t('in 6+ months'),
      'eventually' => t('eventually'),
    ),
  );

  $order = array(
    'blurb',
    'name',
    'mail',
    'phone',
    'cid',
    'buy_sell',
    'when',
    'submit'
  );
  foreach ($order as $key => $field) {
    $form[$field]['#weight'] = $key;
  }
}

/**
 * Form submit function for the contact form.
 */
function c21_marketing_form_contact_site_form_submit($form, &$form_state) {
  // Redirect users to a "Thank You" page on submit.
  $form_state['redirect'] = drupal_get_normal_path('thank-you');
}

/**
 * Implements hook_mail_alter().
 */
function c21_marketing_mail_alter(&$message) {
  // We only want to alter the email if it's being
  // generated by the site-wide contact form page.
  if ($message['id'] == 'contact_page_mail') {
    global $base_url;

    // If we are on a listing, include it for context later.
    $listing = menu_get_object();
    $mls_listing = menu_get_object('drealty_listing');

    if (!is_null($listing)) {
      $wrapper = entity_metadata_wrapper('node', $listing);

      $message['body'][] = t('---- LISTING INFO ----');
      $message['body'][] = t('Listing Title: ' . $listing->title);
      $message['body'][] = t('Listing ID: ' . $wrapper->field_listing_id_prefix->value() . '-' . $listing->nid);
      $message['body'][] = t('MLS#: ' . $wrapper->field_listing_mls->value());
      $message['body'][] = t('Link: ' . $base_url . '/node/' . $listing->nid);
      $message['body'][] = t('----------------------');
      $message['body'][] = t('');
    }

    if (!is_null($mls_listing)) {
      $wrapper = entity_metadata_wrapper('drealty_listing', $mls_listing);

      $message['body'][] = t('---- MLS LISTING INFO ----');
      $message['body'][] = t('Listing Title: ' . $mls_listing->label);
      $message['body'][] = t('MLS#: ' . $wrapper->field_mls_number->value());
      $message['body'][] = t('Link: ' . $base_url . '/drealty_listing/' . $mls_listing->id);
      $message['body'][] = t('----------------------');
      $message['body'][] = t('');
    }

    $message['subject'] = t('@name requested he/she be contacted by c21hull.com', array('@name' => $message['params']['name']));
    if (!empty($message['params']['phone'])) {
      $message['body'][] = t('Phone: ') . $message['params']['phone'];
    }
    $message['body'][] = t('Interested in: ') . $message['params']['buy_sell'];
    $message['body'][] = t('He/She would like to buy or sell in: ') . $message['params']['when'];
  }
}
